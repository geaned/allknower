FROM python:3.12-slim AS base

WORKDIR /app

RUN apt update && \
    apt install git tini build-essential -y && \
    apt clean && \
    apt autoremove -y && \
    rm -rf /root/.cache && \
    rm -rf /var/lib/apt/lists/* && \
    rm -rf /etc/apt/sources.list.d/*

ARG MIDWAY_SEARCH_BACKEND__APP_HOST='0.0.0.0'
ARG MIDWAY_SEARCH_BACKEND__APP_PORT=7866
ARG MIDWAY_SEARCH_BACKEND__PROMETHEUS__HOST='0.0.0.0'
ARG MIDWAY_SEARCH_BACKEND__PROMETHEUS__PORT=8090
ARG MIDWAY_SEARCH_BACKEND__PROMETHEUS__APP_NAME='midway_search'
ARG MIDWAY_SEARCH_BACKEND__QUERYEMBEDDER__TEXT_ENDPOINT='http://195.70.199.13:8766/embed/texts'
ARG MIDWAY_SEARCH_BACKEND__QUERYEMBEDDER__IMAGE_ENDPOINT='http://195.70.199.13:8765/embed/texts'
ARG MIDWAY_SEARCH_BACKEND__BASESEARCH__BASE_URL='http://195.70.199.13:8081'
ARG MIDWAY_SEARCH_BACKEND__BASESEARCH__FULL_TEXT_SEARCH_ENDPOINT='basesearch/search'
ARG MIDWAY_SEARCH_BACKEND__BASESEARCH__VECTOR_SEARCH_ENDPOINT='vectorsearch/search'
ARG MIDWAY_SEARCH_BACKEND__BLENDER__ENDPOINT='http://195.70.199.13:8767/score'


# define env variables
ENV PYTHONPATH=$PWD:$PYTHONPATH \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_ROOT_USER_ACTION=ignore \
    LANG=C.UTF_8 \
    MIDWAY_SEARCH_BACKEND__APP_HOST=${MIDWAY_SEARCH_BACKEND__APP_HOST} \
    MIDWAY_SEARCH_BACKEND__APP_PORT=${MIDWAY_SEARCH_BACKEND__APP_PORT} \
    MIDWAY_SEARCH_BACKEND__PROMETHEUS__HOST=${MIDWAY_SEARCH_BACKEND__PROMETHEUS__HOST} \
    MIDWAY_SEARCH_BACKEND__PROMETHEUS__PORT=${MIDWAY_SEARCH_BACKEND__PROMETHEUS__PORT} \
    MIDWAY_SEARCH_BACKEND__PROMETHEUS__APP_NAME=${MIDWAY_SEARCH_BACKEND__PROMETHEUS__APP_NAME} \
    MIDWAY_SEARCH_BACKEND__QUERYEMBEDDER__TEXT_ENDPOINT=${MIDWAY_SEARCH_BACKEND__QUERYEMBEDDER__TEXT_ENDPOINT} \
    MIDWAY_SEARCH_BACKEND__QUERYEMBEDDER__IMAGE_ENDPOINT=${MIDWAY_SEARCH_BACKEND__QUERYEMBEDDER__IMAGE_ENDPOINT} \
    MIDWAY_SEARCH_BACKEND__BASESEARCH__BASE_URL=${MIDWAY_SEARCH_BACKEND__BASESEARCH__BASE_URL} \
    MIDWAY_SEARCH_BACKEND__BASESEARCH__FULL_TEXT_SEARCH_ENDPOINT=${MIDWAY_SEARCH_BACKEND__BASESEARCH__FULL_TEXT_SEARCH_ENDPOINT} \
    MIDWAY_SEARCH_BACKEND__BASESEARCH__VECTOR_SEARCH_ENDPOINT=${MIDWAY_SEARCH_BACKEND__BASESEARCH__VECTOR_SEARCH_ENDPOINT} \
    MIDWAY_SEARCH_BACKEND__BLENDER__ENDPOINT=${MIDWAY_SEARCH_BACKEND__BLENDER__ENDPOINT}


FROM base AS runtime

COPY requirements/requirements.txt requirements/requirements.txt
RUN --mount=type=secret,id=pip.conf,dst=/etc/pip.conf \
    pip install -r requirements/requirements.txt

COPY src/ src/
COPY configs/ configs/


COPY main.py main.py
# expose ports for application server and Prometheus metrics
EXPOSE ${MIDWAY_SEARCH_BACKEND__APP_PORT} ${MIDWAY_SEARCH_BACKEND__PROMETHEUS__PORT}

ENTRYPOINT ["tini", "-g", "--"]
CMD ["python", "main.py"]
